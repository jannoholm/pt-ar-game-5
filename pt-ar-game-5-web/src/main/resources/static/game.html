<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <link rel="icon" href="favicon.ico">

  <title>Trivia Spree Leaderboard</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

  <style type="text/css">
    body {
      padding-top: 5rem;
      /* color: #fff; */
    }
	
	@media all and (-webkit-min-device-pixel-ratio: 0) and (min-resolution:0.001dpcm) {
    .nes-container.is-rounded.is-dark {
        border-image-repeat:initial !important;
    }
	}
	@media all and (-webkit-min-device-pixel-ratio: 0) and (min-resolution:0.001dpcm) {
		.nes-container.is-rounded {
			border-image-repeat:initial !important;
		}
	}

    .starter-template {
      padding: 3rem 1.5rem;
      text-align: center;
    }

    .answer-button-content {
      cursor: pointer;
    }

    .noselect {
      /* iOS Safari */
      -webkit-touch-callout: none;
      /* Safari */
      -webkit-user-select: none;
      /* Konqueror HTML */
      -khtml-user-select: none;
      /* Old versions of Firefox */
      -moz-user-select: none;
      /* Internet Explorer/Edge */
      -ms-user-select: none;
      /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
      user-select: none;
    }
    
    .red {color: #FF0000;}
    .bold { font-weight: bold;}

    .bg {
      /* The image used */
      background-image: url("bg-leaderboard.jpg");

      /* Full height */
      height: 100%;


      /* Center and scale the image nicely */
      background-color: #09060f00;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
      background-size: contain;
      opacity: .95;
    }
    
    
    
    
    
    
    .cyclic_input {
    float: left;
    padding: 1rem;
    font-size: 5rem;
    position: relative;
    display: table-cell;
    vertical-align: middle;
    text-align: center;
}

.cyclic_input:before,
.cyclic_input:after {
    display: block;
    position: absolute;
    left: 50%;
    font-size: 1rem;
    transform: translateX(-50%);
}

.cyclic_input:before {
    content: '▲';
    top: 0;
}

.cyclic_input:after {
    content: '▼';
    bottom: 0;
}
  </style>
  
  <link href="https://unpkg.com/nes.css@latest/css/nes.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="fonts/barcade/stylesheet.css"/>
  
  
  <style type="text/css">
      html, body, pre, code, kbd, samp {
          font-family: 'Barcade Brawl';
      }
  </style>

</head>

<body class="bg noselect">
  <div class="row text-white" style="margin-left: 0px; margin-right: 0px;">
    <div class="col-1 col-xl-2">
      <!-- Responsive spacing on the edges -->
    </div>
    <div class="col-10 col-xl-8 text-center">
      <!-- Place content here -->
      <!-- MENU -->
      <div class="row">
        <div class="col text-right">
          <span id="sound-icon-content" style="color: black;"><i data-feather="volume-2"></i></span>
        </div>
      </div>
      <!-- SIGNUP FIRST -->
      <div id="signup-first-content" style="display:none;">
        <div class="row mb-5">
          <div class="col text-center"><a class="btn btn-primary nes-btn is-primary" href="signup.html" role="button">REGISTER USER HERE FIRST</a></div>
        </div>
      </div>
      <!-- START GAME -->
      <div id="start-game-content" style="display:none;">
        <div class="row mb-5" style="display:none;">
          <div class="col text-center"><a class="nes-btn is-primary" href="index.html" role="button">Back to leaderboard</a></div>
        </div>
        
        <div class="nes-container is-dark with-title">
        	<p class="title">PLAYER SELECT</p>
        	<div>
        		<div class="row mb-1">
		        		<div class="cyclic_input col" tabindex="0">A</div>
						<div class="cyclic_input col" tabindex="0">A</div>
						<div class="cyclic_input col" tabindex="0">A</div>
	        	</div>
	        	
				
				<div class="row">
					<div class="col">
		          		<a class="nes-btn is-disabled" href="index.html" role="button" id="start-game-button" 
		          		style="
						    text-align: center;
						    font-size: 2vh;
						    width: 25vh;
						">START</a>
					</div>
	        	</div>
        	</div>
        </div>
        
      <!-- GAME ENDED -->
      <div class="pb-5 nes-container is-dark with-title" id="game-ended-content" style="display:none;">
      	<p class="title">End results</p>
        <div class="row">
          <div class="col">
            <strong>GAME ENDED!</strong>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <strong>YOUR SCORE:&nbsp;</strong><strong id="total-score-content">0</strong>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <strong>TOTAL QUESTIONS:&nbsp;</strong><strong id="questions-attempted-content">0</strong>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <strong>CORRECT ANSWERS:&nbsp;</strong><strong id="correct-answers-content">0</strong>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <strong>NEW LEADERBOARD POSITION:&nbsp;</strong><strong id="new-leaderboard-position-content">0</strong>
          </div>
        </div>
      </div>
        
        <div class="row mb-5 nes-container is-dark with-title">
        	<p class="title">HOW TO PLAY</p>
        	Welcome to TRIVIASPREE, a fast-paced quiz game designed to test your knowledge in various fields.
        	
        	<br>
        	<br>
        	You will be bombarded by numerous mind-bending questions in fast succession and must choose the correct answer from four different options. 
        	Your game lasts a modest 120 seconds, so things will move along at a nice tempo. 
        	As with everything in life, sometimes a question can have several correct answers. 
        	Every correct answer rewards you with 100 points. Consecutive correct answers build up a combo multiplier for a chance to x8 your points. 
        	Be warned though, a wrong answer will drop your multiplier by 2 levels.
        	<br>
        	<br>
        	Good luck and have fun!
        	<br>
        	<br>
        	<span class="red bold" style="margin-inline: auto;"> BE WARNED</span> 
        	Mindless mashing will only get you removed from the leaderboard. This is a courteous game where speed of mind, not of the index finger is put to test.
        </div>
        
        
      </div>
      <!-- GAME STARTED -->
      <div id="game-started-content" style="display:none;">
        <div class="row align-items-end" style="display: table; width: 100%;">
          <div class="col nes-container is-rounded is-dark" style="display: table-cell;    width: 20%;">
            <p style="font-size: 2vh; color: #009933; display: none;" id="extra-seconds-content">
              <strong>+<span id="extra-seconds-time">5</span> S</strong>
            </p>
          </div>
          <div class="col nes-container is-rounded is-dark" style="display: table-cell;    width: 60%;">
            <p class="text-white" style="font-size: 3vh"><strong>SCORE:&nbsp;</strong><strong id="score-content">0</strong></p>
          </div>
          <div class="col nes-container is-rounded is-dark" style="display: table-cell;    width: 20%;">
            <p class="text-white" style="font-size: 2vh"><strong>TIME:&nbsp;</strong><strong id="progress-bar-countdown">60</strong></p>
          </div>
        </div>
        <div class="row mb-3 w-100">
          <div class="col text-center w-100">
            <div class="w-100" id="progress-bar-container" style="display: none;"></div>
            <progress id="nes-progress-bar" class="nes-progress is-warning" value="30" max="100"></progress>
          </div>
        </div>
        <div class="row" style="/*height: 30vh*/">
          <div class="col-1 align-self-end">
            <p style="font-size: 2vh;">
              <strong id="question-level-indicator-left">
                <span class="question-level-indicator-10" style="display: none;">|</span><br>
                <span class="question-level-indicator-9" style="display: none;">|</span><br>
                <span class="question-level-indicator-8" style="display: none;">|</span><br>
                <span class="question-level-indicator-7" style="display: none;">|</span><br>
                <span class="question-level-indicator-6" style="display: none;">|</span><br>
                <span class="question-level-indicator-5" style="display: none;">|</span><br>
                <span class="question-level-indicator-4" style="display: none;">|</span><br>
                <span class="question-level-indicator-3" style="display: none;">|</span><br>
                <span class="question-level-indicator-2" style="display: none;">|</span><br>
                <span class="question-level-indicator-1" style="display: none;">|</span><br>
              </strong>
            </p>
          </div>
          <div class="col-10 align-self-center nes-container is-rounded is-dark">
            <p style="width: 100%; font-size: 3vh"><strong id="question-content">Question placeholder</strong></p>
          </div>
          <div class="col-1 align-self-end" style="display: none;">
            <p style="font-size: 2vh;">
              <strong id="question-level-indicator-right">
                <span class="question-level-indicator-10" style="display: none;">|</span><br>
                <span class="question-level-indicator-9" style="display: none;">|</span><br>
                <span class="question-level-indicator-8" style="display: none;">|</span><br>
                <span class="question-level-indicator-7" style="display: none;">|</span><br>
                <span class="question-level-indicator-6" style="display: none;">|</span><br>
                <span class="question-level-indicator-5" style="display: none;">|</span><br>
                <span class="question-level-indicator-4" style="display: none;">|</span><br>
                <span class="question-level-indicator-3" style="display: none;">|</span><br>
                <span class="question-level-indicator-2" style="display: none;">|</span><br>
                <span class="question-level-indicator-1" style="display: none;">|</span><br>
              </strong>
            </p>
          </div>
        </div>
        <div class="row" style="height: 15vh">
          <!--  rgb(226, 27, 60)  rgb(19, 104, 206)  rgb(208, 159, 54)  rgb(38, 137, 12)-->
          <div class="col-6">
            <div class="row answer-button-content nes-container is-rounded" style="background: rgb(226, 27, 60)">
              <div class="col align-self-center">
                <p style="font-size: 1.5vh;"><strong id="answer-content-1">Answer placeholder 1</strong></p>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="row answer-button-content nes-container is-rounded" style="background: rgb(19, 104, 206)">
              <div class="col align-self-center">
                <p style="font-size: 1.5vh;"><strong id="answer-content-2">Answer placeholder 2</strong></p>
              </div>
            </div>
          </div>
        </div>
        <div class="row my-4" style="height: 15vh">
          <div class="col-6">
            <div class="row answer-button-content nes-container is-rounded" style="background: rgb(208, 159, 54)">
              <div class="col align-self-center">
                <p style="font-size: 1.5vh;"><strong id="answer-content-3">Answer placeholder 3</strong></p>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="row answer-button-content nes-container is-rounded" style="background: rgb(38, 137, 12)">
              <div class="col align-self-center">
                <p style="font-size: 1.5vh;"><strong id="answer-content-4">Answer placeholder 4</strong></p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GAME ENDED FEEDBACK -->
      <div class="pt-5" style="display:none;" id="game-feedback-content">
        <form id="game-feedback-form">
          <div class="row justify-content-around">
            <div class="col-xl-4">
              <textarea class="form-control nes-textarea" id="game-feedback-input" rows="3" placeholder="Give us feedback" required></textarea>
            </div>
          </div>
          <div class="row mt-1 justify-content-around">
            <div class="col-xl-4">
              <button type="submit" class="btn-block nes-btn is-warning font-weight-bold">Submit feedback</button>
            </div>
          </div>
          <div class="row mt-3 justify-content-center">
            <div class="col-xl-4 text-center">
              <div class="alert alert-success" style="display:none;" role="alert" id="feedbackSuccessMessage">
                Successfully submitted your feedback!
              </div>
              <div class="alert alert-danger" style="display:none;" role="alert" id="feedbackErrorMessage">
                Something went wrong, let us know!
              </div>
            </div>
          </div>
        </form>
      </div>
      <!-- Main content end-->
    </div>
    <div class="col-1 col-xl-2">
      <!-- Responsive spacing on the edges -->
    </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/soundjs.min.js"></script>


    <!-- Progress bar -->
    <script src="js/progressbar.js-1.1.0/dist/progressbar.min.js"></script>

    <script>

      feather.replace()

      let nickname = null;
      var gameId = null;
      var loadingBarStartTime = null;
      var loadingBarId = null;
      
      KEYCODES = { up: 49, down: 50, left: 51, right: 52 };
      
      
      
      var gameRunning = false;

      if (Cookies.get('nickname') != undefined && Cookies.get('nickname').length == 3) {
        nickname = Cookies.get('nickname');
        $('#start-game-content').show();
      } else {
        $('#signup-first-content').show();
      }

      // Game music
      var sounds = [
        { src: '1.mp3', id: 'sound-1' },
        { src: '2.mp3', id: 'sound-2' },
        { src: '3.mp3', id: 'sound-3' },
        { src: '4.mp3', id: 'sound-4' },
        { src: '5.mp3', id: 'sound-5' },
        { src: '6.mp3', id: 'sound-6' },
      ];

      createjs.Sound.registerSounds(sounds, 'sounds/');
      soundTrack1 = createjs.Sound.createInstance('sound-1');
      soundTrack2 = createjs.Sound.createInstance('sound-2');
      soundTrack3 = createjs.Sound.createInstance('sound-3');
      soundTrack4 = createjs.Sound.createInstance('sound-4');
      soundTrack5 = createjs.Sound.createInstance('sound-5');
      soundTrack6 = createjs.Sound.createInstance('sound-6');
      createjs.Sound.muted = false;

      var audioLoopTimeout = null;
      
      
      // start of sound effects
      const genderSelect = ["male", "female"];
      
      let currentGender = "male";
      
      const malePrefix = "m_";
      const femalePrefix = "f_";
      
      const correctSoundIds = ["bingo", "yup", "scwing", "mhm", "correct", "great job", "nice", "thats a bingo"];
      const incorrectSoundIds = ["nope", "ouch", "wrong"];
      
      const comboBreakerSoundIds = ["combo breaker", "trivia breaker"];
      
      const startSoundIds = ["begin", "get it on", "go", "riddle me this", "start"];
      const stopSoundIds = ["pencils down", "quiz over", "stop", "thats enough"];
      
      const comboSounds = [
    	  correctSoundIds,
    	  ["double quiz", "double", "quizing spree"],
    	  ["tripple", "tripple quizz", "uu baby"],
    	  ["quad", "quadtacular", "quiztacular", "ultra combo"],
    	  ["penta", "pentafrenzy", "quizfrenzy", "monsterquiz"],
    	  ["hexa", "hexatrocity", "quiztrocity", "quizrampage"],
    	  ["hepta", "heptamanjaro", "quizmanjaro", "quizunstoppable"],
    	  ["octa", "octastrophy", "quiztrastophy"]
      ];
      
      const maxCombo = ["godlike", "beyond godlike", "ultra combo"];
      
      let gameSfx = [];
	  
      //registerSound(correctSoundIds, gameSfx);
      registerSound(incorrectSoundIds, gameSfx);
      
      registerSound(startSoundIds, gameSfx);
      registerSound(stopSoundIds, gameSfx);
      
      registerSound(comboBreakerSoundIds, gameSfx);
      registerSound(maxCombo, gameSfx);
      
      for (let s of comboSounds) {
    	  registerSound(s, gameSfx);
      }
      
      console.log(gameSfx);
      
      function registerSound (arr, gameSfx) {
          for (let i of arr){
        	  for (let j of ["male", "female"]){
        		  let payload = {};
            	  payload.src = "vo/" + j + "/" + i + ".wav";
            	  payload.id = (j == "male" ? malePrefix : femalePrefix) + i;
            	  payload.defaultPlayProps = { volume: 1, loop: 0, offset: 0 }
            	  
            	  gameSfx.push(payload)
        	  }
        	  
          }
      }
      
      const registeredSounds = createjs.Sound.registerSounds(gameSfx, 'sounds/');
      
      function playSound(sound, gender) {
    	  const genderPrefix = gender == "male" ? malePrefix : femalePrefix;
    	  createjs.Sound.play(genderPrefix + sound);
      }
      
      function getRandomFromArray(array) {
    	  return array[Math.floor(Math.random()*array.length)]
      }
      
      //end of sound effects

      function startAudio() {
        soundTrack1.play({ volume: 0, loop: -1, offset: 0 });
        soundTrack2.play({ volume: 0, loop: -1, offset: 0 });
        soundTrack3.play({ volume: 0, loop: -1, offset: 0 });
        soundTrack4.play({ volume: 0, loop: -1, offset: 0 });
        soundTrack5.play({ volume: 0, loop: -1, offset: 0 });
        soundTrack6.play({ volume: 0, loop: -1, offset: 0 });

        clearTimeout(audioLoopTimeout);
        audioLoop();
      }


      function audioLoop() {

        const timeLeft = gameMaxTime + gameTotalExtraTime - (Date.now() - gameStartTime);
        console.log('Sound loop, time left=' + timeLeft);

        if (timeLeft > 40000) {
          soundTrack1.volume = 1;
        } else if (timeLeft > 30000) {
          soundTrack1.volume = 0;
          soundTrack2.volume = 1;

        } else if (timeLeft > 20000) {
          soundTrack2.volume = 0;
          soundTrack3.volume = 1;

        } else if (timeLeft > 10000) {
          soundTrack3.volume = 0;
          soundTrack4.volume = 1;
        } else {
          soundTrack4.volume = 0;
          soundTrack5.volume = 1;
        }

        audioLoopTimeout = setTimeout(function () { audioLoop() }, 10000);
      }

      // Time left progress bar
      var progressBar = null;
      var progressBarCountDown = null;
      var gameStartTime = 0;
      const gameMaxTime = 120000;
      var gameTotalExtraTime = 0;
      var currentExtraTimeTimeout = null;
      var currentExtraTimeEnd = 0; // This  can change during current extra time runtime
      
      var progressUpdateInterval;
      var progBar = $("#nes-progress-bar");

      function animateProgressBar() {
    	  
    	progBar[0].setAttribute("value", 0);
    	progressUpdateInterval = window.setInterval(function(){
    		  progBar[0].setAttribute("value", Math.round(progressBar.value()*100));
    	}, 100);

        progressBar.path.setAttribute('stroke', '#FFEA82');

        const gameCurrentTime = Date.now();
        const progress = (gameCurrentTime - gameStartTime) / (gameMaxTime + gameTotalExtraTime);

        progressBar.animate(1, {
          duration: (1 - progress) * gameMaxTime
        }, function () {
          // Max time reached
          console.log('Progress bar finished');
          console.log('Stopping sound');
          clearTimeout(audioLoopTimeout);
          createjs.Sound.stop();

          console.log('Resetting progressbar');
          progressBar.set(0);
          clearInterval(progressBarCountDown);
          
          clearInterval(progressUpdateInterval);

          console.log('Triggering end game session');
          endGameSession();
        });
      }

      function triggerNewExtraTime(newExtraTime) {

        console.log('Pausing progress bar animation for extra time=' + newExtraTime);
        gameTotalExtraTime = gameTotalExtraTime + newExtraTime;

        if (currentExtraTimeEnd == 0) {
          currentExtraTimeEnd = Date.now();
        }

        currentExtraTimeEnd = currentExtraTimeEnd + newExtraTime;

        progressBar.path.setAttribute('stroke', '#009933');
        progressBar.pause(); // According to doc, it should not work, go figure...
        progressBar.stop();

        extraTimeLoop();
      }

      function extraTimeLoop() {

        const extraTimeLeft = currentExtraTimeEnd - Date.now();
        console.log('Extra time loop, time left=' + extraTimeLeft);

        if (currentExtraTimeEnd < Date.now()) {
          console.log('Extra time loop, restarting normal animation');

          currentExtraTimeEnd = 0;

          $('#extra-seconds-time').text(5);
          $('#extra-seconds-content').hide();
          animateProgressBar();
        } else {
          console.log('Updating extra time value and looping next loop in ' + Math.min(extraTimeLeft, 1000));

          $('#extra-seconds-time').text(Math.round(extraTimeLeft / 1000));
          $('#extra-seconds-content').show();

          // Rinse and repeat
          clearTimeout(currentExtraTimeTimeout);
          currentExtraTimeTimeout = setTimeout(function () { extraTimeLoop() }, Math.min(extraTimeLeft, 1000));
        }
      }

      function animateProgressBarCountdown() {
        const timeLeftMillis = gameMaxTime - gameMaxTime * progressBar.value();
        const timeLeft = Math.round(timeLeftMillis / 1000);
        $('#progress-bar-countdown').text('' + timeLeft);
      }

      // Business logic

      function startGame() {
        console.log('Starting game');
        
        
        currentGender = getRandomFromArray(genderSelect);

        jsonPayload = {
          'nickname': nickname
        }

        // Post the data to the server
        $.ajax({
          type: 'POST',
          url: 'api/gamesession/start',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify(jsonPayload),
          success: startGameCallback,
          error: startGameErrorCallback,
          dataType: 'json'
        });

      }

      function startGameCallback(data) {
        console.log('Received response', data);
        gameRunning = true;
        gameId = data.gameId;
        firstQuestion();
      }

      function startGameErrorCallback(data) {
        console.log('Something went wrong!', data);
        gameRunning = false;
      }

      function firstQuestion() {
        jsonPayload = {
          'gameId': gameId
        }

        // Post the data to the server
        $.ajax({
          type: 'POST',
          url: 'api/gamesession/next',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify(jsonPayload),
          success: firstQuestionCallback,
          error: firstQuestionErrorCallback,
          dataType: 'json'
        });
      }

      function firstQuestionCallback(data) {
        console.log('Received response', data);
        playSound(getRandomFromArray(startSoundIds), currentGender);

        $('#question-content').text(data.question);
        $('#answer-content-1').text(data.answers[0]);
        $('#answer-content-2').text(data.answers[1]);
        $('#answer-content-3').text(data.answers[2]);
        $('#answer-content-4').text(data.answers[3]);


        $('#start-game-content').hide();
        $('#game-started-content').show();
        $('#game-ended-content').hide();
        //$('#game-feedback-content').hide();

        gameStartTime = Date.now();
        startAudio();

        animateProgressBar();
        progressBarCountDown = setInterval(animateProgressBarCountdown, 250); // Update every 0.25 seconds
      }

      function firstQuestionErrorCallback(data) {
        console.log('Something went wrong!', data);
        endGameSession();
      }

      function submitAnswer(answer) {

        jsonPayload = {
          'gameId': gameId,
          'lastQuestionAnswer': answer
        }

        // Post the data to the server
        $.ajax({
          type: 'POST',
          url: 'api/gamesession/next',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify(jsonPayload),
          success: submitAnswerCallback,
          error: submitAnswerErrorCallback,
          dataType: 'json'
        });

      }

      let previousCombo = 0;
      
      function submitAnswerCallback(data) {
        console.log('Received response', data);
        
		const lastCorrect = data.lastQuestionCorrect;
		
		const currentCombo = data.level;
        
        if (lastCorrect) {
        	
        	
        	if (currentCombo > comboSounds.length) {
        		playSound(getRandomFromArray(maxCombo), currentGender);
        	} else {
        		playSound(getRandomFromArray(comboSounds[currentCombo - 1]), currentGender);
        	}
        	
        } else {
        	if (currentCombo < previousCombo) {
        		playSound(getRandomFromArray(comboBreakerSoundIds), currentGender);
        	} else {
        		playSound(getRandomFromArray(incorrectSoundIds), currentGender);
        	}
        	
        }

        $('#question-content').text(data.question);
        $('#answer-content-1').text(data.answers[0]);
        $('#answer-content-2').text(data.answers[1]);
        $('#answer-content-3').text(data.answers[2]);
        $('#answer-content-4').text(data.answers[3]);
        $('#score-content').text(data.newTotalScore + " COMBO:" + currentCombo);

        for (let levelIndicator = 1; levelIndicator <= 10; levelIndicator++) {
          $('.question-level-indicator-' + levelIndicator).text('|');
          if (levelIndicator == data.level && data.level != 1) {
            $('.question-level-indicator-' + levelIndicator).text('x' + levelIndicator);
            $('.question-level-indicator-' + levelIndicator).show();
          } else if (levelIndicator < data.level) {
            $('.question-level-indicator-' + levelIndicator).show();
          } else {
            $('.question-level-indicator-' + levelIndicator).hide();
          }
        }

        const extraTime = data.extraTimeAdded;
        if (extraTime > 0) {
          triggerNewExtraTime(extraTime);
        }
        
        previousCombo = currentCombo;
      }

      function submitAnswerErrorCallback(data) {
        console.log('Something went wrong!', data);
        endGameSession();
      }

      function endGameSession() {
    	  
    	  console.log("ending session...");
    	  
    	  clearTimeout(audioLoopTimeout);
          createjs.Sound.stop();

          progressBar.set(0);
          clearInterval(progressBarCountDown);
          clearInterval(progressUpdateInterval);
          
          previousCombo = 0;

        jsonPayload = {
          'gameId': gameId
        }

        // Post the data to the server
        $.ajax({
          type: 'POST',
          url: 'api/gamesession/end',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify(jsonPayload),
          success: endGameCallback,
          error: endGameErrorCallback,
          dataType: 'json'
        });
        
        clearInterval(progressUpdateInterval);

      }

      function endGameCallback(data) {
    	  gameRunning = false;

        $('#total-score-content').text(data.totalScore);
        $('#questions-attempted-content').text(data.questionsAttempted);
        $('#correct-answers-content').text(data.correctAnswers);
        $('#new-leaderboard-position-content').text(data.newLeaderboardPosition);

        $('#start-game-content').show();
        $('#game-started-content').hide();
        $('#game-ended-content').show();
        //$('#game-feedback-content').show();
        $('#score-content').text(0);
        $('progress-bar-countdown').text(0);
        gameTotalExtraTime = 0;

        for (var i = 1; i <= 10; i++) {
          $('.question-level-indicator-' + i).text('|');
          $('.question-level-indicator-' + i).hide();
        }
      }

      function endGameErrorCallback(data) {
    	  gameRunning = false;
    	  
    	  
          $('#start-game-content').show();
          $('#game-started-content').hide();
          $('#game-ended-content').show();
          //$('#game-feedback-content').show();
          $('#score-content').text(0);
          $('progress-bar-countdown').text(0);
          $('#new-leaderboard-position-content').text("Disqualified");
          gameTotalExtraTime = 0;

          for (var i = 1; i <= 10; i++) {
            $('.question-level-indicator-' + i).text('|');
            $('.question-level-indicator-' + i).hide();
          }
      }

      // Feedback form
      function feedbackSuccessCallback(data) {
        console.log('Feedback successfully submitted', + data);
        $('#feedbackSuccessMessage').show();
        $('#feedbackSuccessMessage').fadeOut(2000);
      }

      function feedbackErrorCallback(data) {
        console.log('Feedback submit failed', data);
        $('#feedbackErrorMessage').show();
        $('#feedbackErrorMessage').fadeOut(4000);
      }

      // Initialize everything
      $(document).ready(function () {

        $('#start-game-button').click(function () {
          event.preventDefault();
          startGame();
        });

        var lastAnswerClickTimestamp = 0;
        $('.answer-button-content').click(function (event) {
          console.log('Answer button clicked: ' + $(event.target).parent().find('strong').text());

          if (lastAnswerClickTimestamp + 500 > new Date().getTime()) {
            console.log('Ignoring rapid answer attempts within 500ms');
            return;
          }

          lastAnswerClickTimestamp = new Date().getTime();
          // Parent is needed just in case player clicked on the <strong> element itself
          submitAnswer($(event.target).parent().find('strong').text())
        });

        progressBar = new ProgressBar.Line('#progress-bar-container', {
          easing: 'linear',
          strokeWidth: 2,
          color: '#FFEA82',
          trailColor: '#EEE',
          trailWidth: 1,
          svgStyle: {
            width: '100%',
            height: '100%'
          }
        });
        
        
        var canStart = false;
        
        $('.cyclic_input').on('keydown',function(ev){
      	  console.log("111")
      	    input = $(this);
      	    val = $(this).text();
      	    
      	    var previousStartState = canStart;
      	    
      	    switch (ev.keyCode) {   
      	      case KEYCODES.right:
      	    	  let nextEl = input.next();
      	    	  if (nextEl.length) {
      	    		nextEl.focus();
      	    		console.log("got next")
      	    		canStart = false;
      	    	  } else {
      	    		  console.log("nothing more")
      	    		canStart = true;
      	    	  }
      	        break;
      	      case KEYCODES.left:
      	    	let prevEl = input.prev();
      	    	if (prevEl.length) {
      	    		prevEl.focus();
      	    		console.log("got prev")
      	    		canStart = false;
      	    	  } else {
      	    		  console.log("nothing more")
      	    		canStart = true;
      	    	  }
      	        break;
      	      case KEYCODES.up:
      	        input.text(advanceCharBy(val, 1));
      	        break;
      	      case KEYCODES.down:
      	        input.text(advanceCharBy(val, -1));
      	        break;
      	      default:
      	        if (ev.keyCode >= 65 && ev.keyCode <= 65 + 26) {
      	            input.text(String.fromCharCode(ev.keyCode));
      	            input.next().focus();
      	        }
      	    };
      	    
      	    if (previousStartState && canStart) {
      	    	var username = "";
      	    	$(".cyclic_input ").each(function(index, element) {
      	    		username = username + $(element).text()
      	    	})
      	    	
      	    	console.log("starting game with: ", username)
      	    	nickname = username;
      	    	
      	    	if (!gameRunning) {
      	    		canStart = false;
      	    		 $('#start-game-button').click();
      	    	}
      	          
      	    	
      	    }
      	    
      	    if (canStart) {
      	    	$("#start-game-button").addClass("is-success").removeClass("is-disabled")
      	    } else {
      	    	$("#start-game-button").addClass("is-disabled").removeClass("is-success")
      	    }
      	    
      	    ev.preventDefault();
      	});

      	advanceCharBy = function(char, distance) {
      	    oldCode = char.charCodeAt(0);
      	    newCode = 65 + (oldCode - 65 + 26 + distance) % 26;
      	    return String.fromCharCode(newCode);
      	};

        $(document).keypress(function (e) {
          if (event.key == '1' || event.key == '2' || event.key == '3' || event.key == '4') {
            
            
            //if (!gameRunning)
           // 	$('#start-game-button').click();
            //else
            	
            	if (gameRunning)
            		$('#answer-content-' + event.key).click();
            	else{
            		$(".cyclic_input").first().focus();
            	}
          }
        })

        $('#sound-icon-content').click(function () {
          console.log('clicked');


          if (createjs.Sound.muted) {
            $("#sound-icon-content svg.feather.feather-volume-x").replaceWith(feather.icons['volume-2'].toSvg());
            createjs.Sound.muted = false;
          } else {
            $("#sound-icon-content svg.feather.feather-volume-2").replaceWith(feather.icons['volume-x'].toSvg());
            createjs.Sound.muted = true;
          }
          feather.replace();
        });

        // Feedback form
        $('#game-feedback-form').submit(function (event) {
          // Stop form from submitting normally
          event.preventDefault();

          var nickname = 'anon';

          if (Cookies.get('nickname') != undefined && Cookies.get('nickname').length == 3) {
            nickname = Cookies.get('nickname');
          }

          jsonPayload = {
            'nickname': nickname,
            'feedback': $('#game-feedback-input').val()
          }

          console.log('Submitting feedback: ' + JSON.stringify(jsonPayload));

          // Post the data to the server
          $.ajax({
            type: 'POST',
            url: 'api/player/feedback',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(jsonPayload),
            success: feedbackSuccessCallback,
            error: feedbackErrorCallback,
            dataType: 'json'
          });

          $('#game-feedback-input').val('');

        });

      });

    </script>

</body>

</html>